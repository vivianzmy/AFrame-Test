<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A-Frame Test</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Animation mixer for skinned GLB animations (Mixamo, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script>
      // ============================================
      // FACE CAMERA COMPONENT
      // ============================================
      AFRAME.registerComponent('face-camera', {
        tick: function() {
          const camera = document.querySelector('#camera');
          if (camera) {
            const cameraPos = camera.getAttribute('position');
            const elPos = this.el.getAttribute('position');
            
            const dx = cameraPos.x - elPos.x;
            const dy = cameraPos.y - elPos.y;
            const dz = cameraPos.z - elPos.z;
            
            const yAngle = Math.atan2(dx, dz) * (180 / Math.PI);
            const distance = Math.sqrt(dx * dx + dz * dz);
            const xAngle = -Math.atan2(dy, distance) * (180 / Math.PI);
            
            this.el.setAttribute('rotation', `${xAngle} ${yAngle} 0`);
          }
        }
      });

      // ============================================
      // PNG TRANSPARENCY FIX COMPONENT
      // ============================================
      AFRAME.registerComponent('fix-png-transparency', {
        init: function() {
          this.applyFix = this.applyFix.bind(this);
          
          // Try to apply fix immediately
          this.applyFix();
          
          // Also try after model loads
          this.el.addEventListener('loaded', this.applyFix);
          this.el.addEventListener('model-loaded', this.applyFix);
          
          // Use tick to check when texture becomes available
          this.textureFixed = false;
        },
        
        tick: function() {
          if (!this.textureFixed) {
            this.applyFix();
          }
        },
        
        applyFix: function() {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;
          
          const material = mesh.material;
          if (!material) return;
          
          const texture = material.map;
          if (!texture) return;
          
          // Fix texture settings
          texture.generateMipmaps = false;
          texture.minFilter = THREE.LinearFilter;
          texture.magFilter = THREE.LinearFilter;
          texture.premultiplyAlpha = true;
          texture.needsUpdate = true;
          
          // Fix material settings
          material.transparent = true;
          material.premultipliedAlpha = true;
          material.alphaTest = 0.1;
          material.side = THREE.DoubleSide;
          material.needsUpdate = true;
          
          this.textureFixed = true;
        },
        
        remove: function() {
          this.el.removeEventListener('loaded', this.applyFix);
          this.el.removeEventListener('model-loaded', this.applyFix);
        }
      });

      // ============================================
      // MONEY MANAGEMENT SYSTEM
      // ============================================
      let money = 1000;
      const ITEM_COST = 100;

      // Update money display
      function updateMoneyDisplay() {
        const moneyText = document.querySelector('#money-text');
        if (moneyText) {
          moneyText.setAttribute('value', `$${money}`);
        }
        // Also update HTML HUD
        const hud = document.querySelector('#hud');
        if (hud) {
          hud.textContent = `$${money}`;
        }
      }

      // Deduct cost from money (prevents going negative)
      function deductCost(cost) {
        if (money >= cost) {
          money -= cost;
          updateMoneyDisplay();
          return true;
        }
        return false;
      }

      // ============================================
      // TOAST NOTIFICATION SYSTEM
      // ============================================
      function showToast(itemName) {
        // Get camera
        const camera = document.querySelector('#camera');
        if (!camera) {
          console.error('Camera not found!');
          return;
        }

        // Remove existing toast if any
        const existingToast = document.querySelector('#toast-notification');
        if (existingToast) {
          existingToast.parentNode.removeChild(existingToast);
        }

        // Create toast element - attached to camera as HUD
        const toast = document.createElement('a-text');
        toast.setAttribute('id', 'toast-notification');
        toast.setAttribute('value', `+ ${itemName}`);
        // Camera-local coordinates for bottom-left corner
        const toastX = -1.6;
        const toastY = -0.7;
        const toastZ = -1;
        toast.setAttribute('position', `${toastX} ${toastY} ${toastZ}`);
        toast.setAttribute('align', 'left');
        toast.setAttribute('color', '#4dcc4d');
        toast.setAttribute('scale', '0.3 0.3 0.3');
        toast.setAttribute('opacity', '0');
        
        // Attach to camera (not scene) - this makes it behave like a HUD
        camera.appendChild(toast);

        // Fade in animation
        toast.setAttribute('animation__fadein', 'property: opacity; from: 0; to: 1; dur: 200');
        
        // After 1 second, fade out and remove
        setTimeout(() => {
          toast.setAttribute('animation__fadeout', 'property: opacity; from: 1; to: 0; dur: 300');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 1000);
      }

      // ============================================
      // MENU CHOICE COMPONENT
      // ============================================
      // This component handles clicks on menu items
      // It reads the itemName from the clicked entity's data attribute
      // The click detection uses mouse-based raycaster, so it targets the actual entity under the mouse cursor
      AFRAME.registerComponent('menu-choice', {
        schema: {
          itemName: { type: 'string', default: 'Item' },
          cost: { type: 'number', default: 100 }
        },
        
        init: function() {
          // Set starting opacity to 0 so colliders are invisible by default
          this.el.setAttribute('material', 'opacity', 0);
          
          // Click handler: reads itemName from the actual clicked entity
          // HOW CLICK TARGET TEXT IS RETRIEVED:
          // 1. The mouse-based raycaster (rayOrigin: mouse) ensures clicks happen where the mouse cursor is
          // 2. When a menu item is clicked, the event fires on that specific entity (this.el)
          // 3. We read the itemName from this.el.components['menu-choice'].data.itemName
          // 4. This guarantees we get the exact text from the entity that was actually intersected by the mouse raycast
          this.handleClick = (evt) => {
            // DEBUG: Log click event
            console.log('CLICK', this.data.itemName, this.el.getAttribute('position'));
            
            // Get the clicked entity - this.el is the entity that was actually intersected by the mouse raycaster
            // The mouse raycaster (rayOrigin: mouse) ensures this is the entity under the mouse cursor, not the center reticle
            const clickedEntity = this.el;
            
            // Read itemName from the clicked entity's menu-choice component data
            // This ensures we get the exact text from the entity that was clicked
            const menuChoiceComponent = clickedEntity.components['menu-choice'];
            if (!menuChoiceComponent) {
              console.error('Menu choice component not found on clicked entity');
              return;
            }
            
            // Get the exact item name from the clicked entity's component data
            const itemName = menuChoiceComponent.data.itemName;
            const cost = menuChoiceComponent.data.cost;
            
            // Deduct cost
            if (deductCost(cost)) {
              // Show toast notification with the exact item name from the clicked entity
              // The toast text is updated based on the clicked item's itemName property
              showToast(itemName);
              console.log(`Purchased: ${itemName} for $${cost}. Remaining: $${money}`);
            } else {
              console.log(`Insufficient funds! Need $${cost}, have $${money}`);
            }
          };
          
          // Attach click listener to this specific menu item entity
          // The mouse raycaster will only trigger this if the mouse cursor is over this entity
          this.el.addEventListener('click', this.handleClick);
          
          // Hover feedback: only change opacity on mouseenter/mouseleave
          this.el.addEventListener('mouseenter', () => {
            this.el.setAttribute('material', 'opacity', 0.2);
          });
          this.el.addEventListener('mouseleave', () => {
            this.el.setAttribute('material', 'opacity', 0);
          });
        },
        
        remove: function() {
          this.el.removeEventListener('click', this.handleClick);
        }
      });

      // Initialize money display and raycaster intersection logging when scene loads
      document.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('a-scene');
        scene.addEventListener('loaded', () => {
          updateMoneyDisplay();
          
          // DEBUG: Listen to raycaster-intersection events to verify mouse-based raycasting
          const mouseCursorEl = document.querySelector('#mouseCursor');
          if (mouseCursorEl) {
            mouseCursorEl.addEventListener('raycaster-intersection', (e) => {
              const intersections = e.detail.intersections || [];
              const itemNames = intersections
                .map(i => {
                  if (i.object && i.object.el) {
                    const menuChoice = i.object.el.components['menu-choice'];
                    return menuChoice ? menuChoice.data.itemName : null;
                  }
                  return null;
                })
                .filter(name => name !== null);
              console.log('Intersections from mouse:', itemNames);
            });
            
            mouseCursorEl.addEventListener('raycaster-intersection-cleared', () => {
              console.log('Mouse raycaster cleared (no intersections)');
            });
          } else {
            console.error('mouseCursor element not found!');
          }
        });
      });
    </script>
    <style>
      html, body { margin: 0; height: 100%; }
      #hud {
        position: fixed;
        top: 20px;
        right: 20px;
        color: #565656;
        font-size: 32px;
        font-weight: bold;
        font-family: Arial, sans-serif;
        pointer-events: none;
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <div id="hud">$1000</div>
    <a-scene>
      <!-- Assets -->
      <a-assets>
        <!-- Mixamo sitting idle character -->
        <a-asset-item id="sittingModel" src="/Sitting Idle (3).glb"></a-asset-item>
      </a-assets>
      <!-- Camera with mouse-based raycaster for desktop interaction -->
      <!-- 
        MOUSE RAYCASTER SETUP:
        - Dedicated mouseCursor entity inside camera owns cursor + raycaster components
        - cursor="rayOrigin: mouse" makes clicks based on mouse position (not center reticle)
        - raycaster="objects: .menu-item-clickable" only targets menu items
        - No visual cursor ring - this is a desktop mouse experience
        - Click events are triggered automatically by the mouse raycaster
      -->
      <a-camera 
        id="camera" 
        position="0 2.2 -2.5" 
        look-controls="enabled: true">
        <!-- Dedicated mouse cursor entity - invisible, handles mouse-based raycasting -->
        <a-entity
          id="mouseCursor"
          cursor="rayOrigin: mouse; fuse: false"
          raycaster="objects: .menu-item-clickable; far: 50">
        </a-entity>
      </a-camera>
      <a-entity gltf-model="url(/potted_plant_mediterranean_med_leaf_low_poly.glb)" position="-4 0 -8.5"  scale="2 2 2"></a-entity>
      <!-- Menu Image -->
      <a-entity id="menu-container" position="0 4 -8.8">
        <a-image 
          src="/MENU-01.png"
          position="0 0 0"
          width="8"
          height="5.18"
          material="transparent: true; alphaTest: 0.1; shader: flat; side: double"
          fix-png-transparency>
        </a-image>

        <!-- Clickable Menu Items -->
        <!-- Menu is 8 units wide, 5.18 units tall -->
        <!-- Items are positioned relative to menu center (0, 0, 0) -->
        <!-- Each collider is narrow (width 2.4) and short (height 0.22) to match individual text lines -->
        <!-- X positions: PERSONALITY (left) x=-2.4, TECHNICAL (center) x=0, SOCIAL (right) x=2.4 -->
        <!-- Y positions: one row every -0.3 units, starting at 0.4 for the first item in each column -->
        <!-- Z position: 0.05 (slightly in front of menu image at z=0) -->

        <!-- PERSONALITY Section (left column, x = -2.4, 9 items) -->
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Confidence Boost; cost: 100"
          position="-2.4 -0.38 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Politeness Filter; cost: 100"
          position="-2.4 -0.58 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Small-Talk Expansion Pack; cost: 100"
          position="-2.4 -0.78 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Empathy Upgrade; cost: 100"
          position="-2.4 -0.98 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Agreeableness; cost: 100"
          position="-2.4 -1.18 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Charisma / Humor; cost: 100"
          position="-2.4 -1.38 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Leadership Aura; cost: 100"
          position="-2.4 -1.58 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: No-Awkwardness; cost: 100"
          position="-2.4 -1.78 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Likeability Boost; cost: 100"
          position="-2.4 -1.98 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>

        <!-- TECHNICAL Section (center column, x = 0, 9 items) -->
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Advanced Math Fluency; cost: 100"
          position="0 -0.38 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Data Analysis Literacy; cost: 100"
          position="0 -0.58 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Public Speaking Mastery; cost: 100"
          position="0 -0.68 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Financial Literacy; cost: 100"
          position="0 -0.88 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Software Proficiency (All); cost: 100"
          position="0 -1.08 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Scientific Reasoning Boost; cost: 100"
          position="0 -1.28 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Fast Research Capability; cost: 100"
          position="0 -1.48 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Memory Enhancement; cost: 100"
          position="0 -1.68 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Fluent in All Languages; cost: 100"
          position="0 -1.88 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>

        <!-- SOCIAL Section (right column, x = 2.4, 7 items) -->
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Negotiation Ability; cost: 100"
          position="2.4 -0.28 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Client Fluency; cost: 100"
          position="2.4 -0.48 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Leadership Skill Pack; cost: 100"
          position="2.4 -0.68 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Collaboration Efficiency; cost: 100"
          position="2.4 -0.88 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Conflict Management; cost: 100"
          position="2.4 -1.08 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Multitasking Ability; cost: 100"
          position="2.4 -1.28 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
        
        <a-plane 
          class="menu-item-clickable"
          menu-choice="itemName: Quick Learning; cost: 100"
          position="2.4 -1.48 0.05"
          width="2.4"
          height="0.22"
          material="color: #00ff00; transparent: true; opacity: 0; side: double">
        </a-plane>
      </a-entity>
      <a-entity gltf-model="url(/potted_plant_wk_8.glb)" position="4 0.7 -8.3" scale="0.02 0.02 0.02"></a-entity>
      <a-entity gltf-model="url(/ceiling_fluorescent_light.glb)"
                material="emissive:#ffffff; emissiveIntensity:2"
                position="0 10 -2.5"
                scale="0.05 0.05 0.05"
                rotation="0 90 0">
        <a-light type="spot"
                 color="#fffdd0"
                 intensity="2"
                 angle="60"
                 penumbra="0.5"
                 distance="25"
                 decay="2"
                 position="0 10 -2.5"
                 rotation="-90 0 0"></a-light>
      </a-entity>
  
    
      <a-light type="ambient"
               color="#ffffff"
               intensity="0.25"></a-light>

      <a-entity gltf-model="url(/free_empty_room.glb)" position="0 0 -4"></a-entity>
      <a-entity position="0 0 -2.5" rotation="0 180 0" scale="0.01 0.01 0.01">
        <a-entity gltf-model="url(/elsie_stackable_dining_chair_white.glb)" scale="2 2 2"></a-entity>
      </a-entity>
      <a-entity gltf-model="url(/door_with_frame.glb)" position="0 0 1" rotation="0 180 0" scale="0.02 0.02 0.02"></a-entity>
      <a-entity gltf-model="url(/window_blind02_-_2mb.glb)" position="2.8 4.3 0.8" rotation="0 90 0" scale="1.6 1.6 1.6"></a-entity>
      <a-entity gltf-model="url(/window_blind02_-_2mb.glb)" position="-2.8 4.3 0.8" rotation="0 90 0" scale="1.6 1.6 1.6"></a-entity>
      <a-entity gltf-model="url(/long_table_and_chairs_low_poly.glb)" position="0 0 -4" rotation="0 180 0" scale="2 2 2"></a-entity>
      <a-entity gltf-model="url(/tablet_folder.glb)" position="0.5 1.45 -4" rotation="0 90 0" scale="0.02 0.02 0.02"></a-entity>

      <!-- Money counter in 3D space (optional, if you want it in the scene) -->
      <a-text 
        id="money-text"
        value="$1000"
        position="2 2.5 -2.5"
        align="left"
        color="#565656"
        scale="2 2 2"
        visible="false"        
        look-at="#camera">
      </a-text>
      <!-- Sitting character model (Mixamo GLB) replacing the red box -->
      <a-entity 
        id="sittingPerson"
        gltf-model="#sittingModel"
        animation-mixer="clip: *; loop: repeat; reorient: true; startAt: 0.5;"
        position="0.7 -0.3 -4.9"
        rotation="0 0 0"
        scale="2.5 2.5 2.5">
      </a-entity>
      <a-plane 
               position="0 0 -4" 
               rotation="-90 0 0" 
               width="4" 
               height="4" 
               scale="2 2 1" 
               color="#7BC8A4">
      </a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
  </body>
  </html>


